// =============================================
//               CONFIGURATION
// =============================================
const OWNER_ID = '1042926851'; // –í–∞—à ID –í–ª–∞–¥–µ–ª—å—Ü–∞
const DEBUG_MODE = false;
const AI_ANALYSIS_DAYS = 90;

const SCRIPT_PROPS = PropertiesService.getScriptProperties();
const TELEGRAM_TOKEN = SCRIPT_PROPS.getProperty('TELEGRAM_TOKEN');
const GEMINI_API_KEY = SCRIPT_PROPS.getProperty('GEMINI_API_KEY');

const sheetExpense = '–†–∞—Å—Ö–æ–¥—ã';
const sheetIncome = '–î–æ—Ö–æ–¥—ã';
const settingSheet = 'Setting';
const goalsSheet = '–¶–µ–ª–∏';
const budgetsSheet = '–ë—é–¥–∂–µ—Ç—ã';
const familiesSheet = '–°–µ–º—å–∏';

// =============================================
//               CURRENCY CONFIGURATION
// =============================================
const CURRENCIES = {
  UZS: { name: '–°—É–º', symbol: '—Å—É–º', rate: 1 },
  USD: { name: '–î–æ–ª–ª–∞—Ä', symbol: '$', rate: 12500 }, // –ü—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å 1 USD = 12500 UZS
  EUR: { name: '–ï–≤—Ä–æ', symbol: '‚Ç¨', rate: 13500 },   // –ü—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å 1 EUR = 13500 UZS
  RUB: { name: '–†—É–±–ª—å', symbol: '‚ÇΩ', rate: 135 }     // –ü—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å 1 RUB = 135 UZS
};

const DEFAULT_CURRENCY = 'UZS';

// =============================================
//               CURRENCY HELPERS
// =============================================
function convertCurrency(amount, fromCurrency, toCurrency = 'UZS') {
  if (fromCurrency === toCurrency) return amount;
  
  const fromRate = CURRENCIES[fromCurrency]?.rate || 1;
  const toRate = CURRENCIES[toCurrency]?.rate || 1;
  
  return (amount * fromRate) / toRate;
}

function detectCurrency(text) {
  const lowerText = text.toLowerCase();
  
  // –ü–æ–∏—Å–∫ —Å–∏–º–≤–æ–ª–æ–≤ –≤–∞–ª—é—Ç
  if (lowerText.includes('$') || lowerText.includes('–¥–æ–ª–ª–∞—Ä') || lowerText.includes('usd')) {
    return 'USD';
  }
  if (lowerText.includes('‚Ç¨') || lowerText.includes('–µ–≤—Ä–æ') || lowerText.includes('eur')) {
    return 'EUR';
  }
  if (lowerText.includes('‚ÇΩ') || lowerText.includes('—Ä—É–±–ª—å') || lowerText.includes('rub')) {
    return 'RUB';
  }
  if (lowerText.includes('—Å—É–º') || lowerText.includes('uzs')) {
    return 'UZS';
  }
  
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—É—é –≤–∞–ª—é—Ç—É
  return DEFAULT_CURRENCY;
}

function formatCurrency(amount, currency = 'UZS') {
  const currencyInfo = CURRENCIES[currency];
  if (!currencyInfo) return formatMoney(amount);
  
  return `${formatMoney(amount)} ${currencyInfo.symbol}`;
}

function formatMultiCurrency(originalAmount, originalCurrency, convertedAmount) {
  const currencyInfo = CURRENCIES[originalCurrency];
  if (!currencyInfo || originalCurrency === 'UZS') {
    return formatMoney(originalAmount);
  }
  
  return `${formatMoney(originalAmount)} ${currencyInfo.symbol} (${formatMoney(convertedAmount)} —Å—É–º)`;
}

// =============================================
//               COMMANDS & KEYBOARDS
// =============================================
const COMMANDS = { 
  addExpense: "‚úö –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥", 
  addIncome: "üí∞ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥", 
  viewReport: "üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á—ë—Ç", 
  askAnalyst: "ü§ñ –°–ø—Ä–æ—Å–∏—Ç—å –ê–Ω–∞–ª–∏—Ç–∏–∫–∞", 
  settings: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", 
  familyMode: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º–µ–π–Ω—ã–π —Ä–µ–∂–∏–º", 
  myBudget: "üí∞ –ú–æ–π –ë—é–¥–∂–µ—Ç", 
  myGoals: "üéØ –ú–æ–∏ —Ü–µ–ª–∏", 
  setupCategories: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤", 
  addNewCategory: "üõ†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ä–∞—Å—Ö–æ–¥–æ–≤", 
  updateRates: "üí± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç", 
  migrateData: "üîÑ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ", 
  clearBase: "üßπ –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É", 
  back: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", 
  newGoal: "‚ûï –ù–æ–≤–∞—è —Ü–µ–ª—å", 
  listMyGoals: "üìã –°–ø–∏—Å–æ–∫ –º–æ–∏—Ö —Ü–µ–ª–µ–π", 
  backToSettings: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏", 
  suggestBudget: "üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –±—é–¥–∂–µ—Ç", 
  setupManually: "‚úèÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é", 
  viewBudget: "üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±—é–¥–∂–µ—Ç", 
  forecast: "üîÆ –ü—Ä–æ–≥–Ω–æ–∑", 
  detailedReport: "üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç", 
  viewBalance: "üí∞ –ë–∞–ª–∞–Ω—Å", 
  createFamily: "üè† –°–æ–∑–¥–∞—Ç—å —Å–µ–º—å—é", 
  joinFamily: "üë• –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–µ–º—å–µ", 
  myFamily: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ú–æ—è —Å–µ–º—å—è", 
  leaveFamily: "üö™ –ü–æ–∫–∏–Ω—É—Ç—å —Å–µ–º—å—é",
  // –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
  setUsdRate: "üíµ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å USD",
  setEurRate: "üí∂ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å EUR", 
  setRubRate: "üí∑ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å RUB",
  viewCurrentRates: "üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã"
};
const mainKeyboard = { keyboard: [[{ text: COMMANDS.addExpense }, { text: COMMANDS.addIncome }], [{ text: COMMANDS.viewReport }], [{ text: COMMANDS.askAnalyst }], [{ text: COMMANDS.settings }]], resize_keyboard: true, is_persistent: true };
const settingsKeyboard = { keyboard: [[{ text: COMMANDS.familyMode }], [{ text: COMMANDS.myBudget }], [{ text: COMMANDS.myGoals }], [{ text: COMMANDS.setupCategories }], [{ text: COMMANDS.addNewCategory }], [{ text: COMMANDS.updateRates }], [{ text: COMMANDS.migrateData }], [{ text: COMMANDS.clearBase }], [{ text: COMMANDS.back }]], resize_keyboard: true, is_persistent: true };
const currencyRatesKeyboard = { keyboard: [[{ text: COMMANDS.setUsdRate }, { text: COMMANDS.setEurRate }], [{ text: COMMANDS.setRubRate }], [{ text: COMMANDS.viewCurrentRates }], [{ text: COMMANDS.backToSettings }]], resize_keyboard: true, is_persistent: true };
const goalsKeyboard = { keyboard: [[{ text: COMMANDS.newGoal }, { text: COMMANDS.listMyGoals }], [{ text: COMMANDS.backToSettings }]], resize_keyboard: true, is_persistent: true };
const budgetKeyboard = { keyboard: [[{ text: COMMANDS.suggestBudget }, { text: COMMANDS.setupManually }], [{ text: COMMANDS.viewBudget }], [{ text: COMMANDS.backToSettings }]], resize_keyboard: true, is_persistent: true };
const reportsKeyboard = { keyboard: [[{ text: COMMANDS.forecast }], [{ text: COMMANDS.detailedReport }, { text: COMMANDS.viewBalance }], [{ text: COMMANDS.back }]], resize_keyboard: true, is_persistent: true };
const familyKeyboard = { keyboard: [[{ text: COMMANDS.createFamily }, { text: COMMANDS.joinFamily }], [{ text: COMMANDS.myFamily }, { text: COMMANDS.leaveFamily }], [{ text: COMMANDS.backToSettings }]], resize_keyboard: true, is_persistent: true };
const unauthorizedKeyboard = { keyboard: [[{ text: COMMANDS.createFamily }, { text: COMMANDS.joinFamily }]], resize_keyboard: true, is_persistent: true };

// =============================================
//         TELEGRAM & AI API HELPERS
// =============================================
function callTelegramApi(method, payload) { 
  if (!TELEGRAM_TOKEN) { 
    Logger.log("TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!"); 
    return; 
  } 
  const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/${method}`; 
  const options = { 
    method: "post", 
    contentType: "application/json", 
    payload: JSON.stringify(payload), 
    muteHttpExceptions: true 
  }; 
  try { 
    return UrlFetchApp.fetch(url, options); 
  } catch (e) { 
    Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –º–µ—Ç–æ–¥–∞ ${method}: ${e}`); 
  } 
}
function callGeminiApi(prompt) { 
  if (!GEMINI_API_KEY) { 
    Logger.log("–û—à–∏–±–∫–∞: –ö–ª—é—á GEMINI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω."); 
    return "–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."; 
  } 
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`; 
  const payload = { 
    "contents": [{ "parts": [{ "text": prompt }] }] 
  }; 
  const options = { 
    'method': 'post', 
    'contentType': 'application/json', 
    'payload': JSON.stringify(payload), 
    'muteHttpExceptions': true 
  }; 
  try { 
    const response = UrlFetchApp.fetch(apiUrl, options); 
    const responseCode = response.getResponseCode(); 
    const responseText = response.getContentText(); 
    if (responseCode !== 200) { 
      Logger.log(`–û–®–ò–ë–ö–ê: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –∫–æ–¥ ${responseCode}. –û—Ç–≤–µ—Ç: ${responseText}`); 
      return `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–∏—Å–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–ö–æ–¥: ${responseCode})`; 
    } 
    const data = JSON.parse(responseText); 
    if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) { 
      return data.candidates[0].content.parts[0].text.trim(); 
    } else { 
      Logger.log(`–û–®–ò–ë–ö–ê: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞. –û—Ç–≤–µ—Ç: ${responseText}`); 
      return "–ò–ò –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç."; 
    } 
  } catch (e) { 
    Logger.log("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: " + e.toString()); 
    return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞."; 
  } 
}
const sendText = (chat_id, text, parse_mode, reply_markup) => { 
  const payload = { 
    chat_id: String(chat_id), 
    text: text, 
    parse_mode: parse_mode || "HTML" 
  }; 
  if (reply_markup) { 
    payload.reply_markup = JSON.stringify(reply_markup); 
  } 
  callTelegramApi("sendMessage", payload); 
};
const deleteMessage = (chat_id, message_id) => callTelegramApi("deleteMessage", { chat_id: String(chat_id), message_id: message_id });
const answerCallback = (callback_id) => callTelegramApi("answerCallbackQuery", { callback_query_id: callback_id });
const editMessageText = (chat_id, message_id, text, parse_mode, reply_markup) => { 
  const payload = { 
    chat_id: String(chat_id), 
    message_id: message_id, 
    text: text, 
    parse_mode: parse_mode, 
    reply_markup: JSON.stringify(reply_markup) 
  }; 
  callTelegramApi("editMessageText", payload); 
};
function sendPhoto(chat_id, photo_url, caption) { 
  const payload = { 
    chat_id: String(chat_id), 
    photo: photo_url, 
    caption: caption, 
    parse_mode: "Markdown" 
  }; 
  callTelegramApi("sendPhoto", payload); 
}

// =============================================
//           MAIN HANDLER
// =============================================
function doPost(e) {
  let contents; 
  try { 
    contents = JSON.parse(e.postData.contents); 
  } catch (err) { 
    return; 
  }
  const message = contents.message; 
  const callback = contents.callback_query;
  let chat_id, text, userFirstName;
  if (message) { 
    chat_id = message.chat.id; 
    text = message.text ? message.text.trim() : ''; 
    userFirstName = message.from ? message.from.first_name : ''; 
  }
  else if (callback) { 
    chat_id = callback.message.chat.id; 
    text = ''; 
    userFirstName = callback.from ? callback.from.first_name : ''; 
  }
  else { 
    return; 
  }
  chat_id = String(chat_id);
  const familyInfo = getFamilyInfo(chat_id);
  if (chat_id === OWNER_ID || familyInfo) {
    const textCommandRouter = {
      "/start": handleStart, 
      [COMMANDS.addExpense]: (c) => sendCategoryButtons(c, '—Ä–∞—Å—Ö–æ–¥'), 
      [COMMANDS.addIncome]: (c) => sendCategoryButtons(c, '–¥–æ—Ö–æ–¥'),
      [COMMANDS.askAnalyst]: handleAskAnalyst, 
      [COMMANDS.viewReport]: handleReportsMenu, 
      [COMMANDS.forecast]: handleForecast,
      [COMMANDS.detailedReport]: sendReport, 
      [COMMANDS.viewBalance]: handleBalance, 
      [COMMANDS.settings]: sendSettingsMenu,
      [COMMANDS.back]: sendMainMenu, 
      [COMMANDS.backToSettings]: sendSettingsMenu, 
      [COMMANDS.familyMode]: handleFamilyMode,
      [COMMANDS.myBudget]: handleMyBudget, 
      [COMMANDS.myGoals]: handleMyGoals, 
      [COMMANDS.setupCategories]: sendConfigureExpenseCategoryMenu,
      [COMMANDS.addNewCategory]: handleNewCategory, 
      [COMMANDS.clearBase]: askClearConfirmation, 
      [COMMANDS.newGoal]: handleNewGoal,
      [COMMANDS.listMyGoals]: handleListGoals, 
      [COMMANDS.suggestBudget]: handleSuggestBudget, 
      [COMMANDS.setupManually]: handleSetupBudgetManually,
      [COMMANDS.viewBudget]: handleViewCurrentBudget, 
      [COMMANDS.createFamily]: handleCreateFamily, 
      [COMMANDS.joinFamily]: handleJoinFamily,
      [COMMANDS.myFamily]: handleViewMyFamily, 
      [COMMANDS.leaveFamily]: handleLeaveFamily
    };
    if (message) { 
      const handler = textCommandRouter[text]; 
      if (handler) { 
        handler(chat_id); 
      } else { 
        handleUserInput(chat_id, text, userFirstName); 
      } 
    }
    else if (callback) { 
      handleCallbackQuery(callback); 
    }
  } else {
    const unauthorizedRouter = { 
      "/start": handleStart, 
      [COMMANDS.createFamily]: handleCreateFamily, 
      [COMMANDS.joinFamily]: handleJoinFamily 
    };
    if (message) { 
      const handler = unauthorizedRouter[text]; 
      if (handler) { 
        handler(chat_id); 
      } else { 
        const state = PropertiesService.getUserProperties().getProperty(chat_id + "_state"); 
        if (state === "awaiting_family_name") { 
          createFamily(chat_id, userFirstName, text); 
        } else if (state === "awaiting_invite_code") { 
          joinFamily(chat_id, userFirstName, text); 
        } else { 
          sendText(chat_id, "üîê –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å–µ–º—å–µ.", null, unauthorizedKeyboard); 
        } 
      } 
    }
  }
}

// =============================================
//     LEVEL 6.1 - PROACTIVE FUNCTIONS
// =============================================
function sendWeeklyDigest() {
  Logger.log("--- –ó–∞–ø—É—Å–∫ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ ---");
  const allUserIds = getAllUserIds();
  Logger.log("–ù–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏: " + allUserIds.length);
  allUserIds.forEach(userId => {
    Logger.log("–ì–æ—Ç–æ–≤–ª—é –¥–∞–π–¥–∂–µ—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + userId);
    const dateLimit = new Date();
    dateLimit.setDate(dateLimit.getDate() - 7);
    const incomeSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetIncome);
    const expenseSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetExpense);
    const allIncomes = incomeSheet.getLastRow() > 1 ? incomeSheet.getRange(2, 1, incomeSheet.getLastRow() - 1, 5).getValues() : [];
    const allExpenses = expenseSheet.getLastRow() > 1 ? expenseSheet.getRange(2, 1, expenseSheet.getLastRow() - 1, 5).getValues() : [];
    const userWeeklyIncomes = allIncomes.filter(row => String(row[4]) === userId && new Date(row[0]) >= dateLimit);
    const userWeeklyExpenses = allExpenses.filter(row => String(row[4]) === userId && new Date(row[0]) >= dateLimit);
    const totalIncome = userWeeklyIncomes.reduce((sum, row) => sum + Number(row[2] || 0), 0);
    const totalExpenses = userWeeklyExpenses.reduce((sum, row) => sum + Number(row[2] || 0), 0);
    if (totalIncome === 0 && totalExpenses === 0) {
      Logger.log("–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + userId + " –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.");
      return;
    }
    const expensesByCategory = {};
    userWeeklyExpenses.forEach(row => {
      const category = row[1];
      const amount = Number(row[2] || 0);
      expensesByCategory[category] = (expensesByCategory[category] || 0) + amount;
    });
    let topCategory = "–ù–µ—Ç";
    let maxSpent = 0;
    for (const category in expensesByCategory) {
      if (expensesByCategory[category] > maxSpent) {
        maxSpent = expensesByCategory[category];
        topCategory = category;
      }
    }
    let digestMessage = "üóìÔ∏è *–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∞–π–¥–∂–µ—Å—Ç*\n\n";
    digestMessage += `–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π:\n\n`;
    digestMessage += `üìà *–î–æ—Ö–æ–¥—ã:* ${formatMoney(totalIncome)} —Å—É–º\n`;
    digestMessage += `üìâ *–†–∞—Å—Ö–æ–¥—ã:* ${formatMoney(totalExpenses)} —Å—É–º\n\n`;
    digestMessage += `üí∏ *–°–∞–º–∞—è –±–æ–ª—å—à–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç—Ä–∞—Ç:* ${topCategory} (${formatMoney(maxSpent)} —Å—É–º)\n\n`;
    digestMessage += `–•–æ—Ä–æ—à–µ–π —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏!`;
    sendText(userId, digestMessage, "Markdown");
    Logger.log("–î–∞–π–¥–∂–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: " + userId);
  });
  Logger.log("--- –†–∞—Å—Å—ã–ª–∫–∞ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ---");
}

// =============================================
//           HANDLERS
// =============================================
function handleStart(chat_id) { 
  const userProps = PropertiesService.getUserProperties(); 
  userProps.deleteProperty(chat_id + "_state"); 
  userProps.deleteProperty(chat_id + "_awaiting_ai_question"); 
  userProps.deleteProperty(chat_id + "_selected"); 
  userProps.deleteProperty(chat_id + "_awaitingCategory"); 
  userProps.deleteProperty(chat_id + "_temp_goal"); 
  userProps.deleteProperty(chat_id + "_temp_budget"); 
  userProps.deleteProperty(chat_id + "_last_transaction"); 
  const familyInfo = getFamilyInfo(chat_id); 
  if (chat_id === OWNER_ID || familyInfo) { 
    sendMainMenu(chat_id); 
  } else { 
    sendText(chat_id, "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –≠—Ç–æ –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏—á–Ω—ã–º–∏ –∏ —Å–µ–º–µ–π–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏.", null, unauthorizedKeyboard); 
  } 
}
function handleNewCategory(chat_id) { 
  PropertiesService.getUserProperties().setProperty(chat_id + "_awaitingCategory", "true"); 
  sendText(chat_id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:"); 
}
function handleAskAnalyst(chat_id) { 
  PropertiesService.getUserProperties().setProperty(chat_id + "_awaiting_ai_question", "true"); 
  sendText(chat_id, "üí¨ –ó–∞–¥–∞–π—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å...", "Markdown"); 
}
function classifyExpenseWithAI(chat_id, text) {
  // 1. –°–Ω–∞—á–∞–ª–∞ –∂–µ—Å—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Å–∞–º—ã—Ö –æ—á–µ–≤–∏–¥–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
  const lowerText = text.toLowerCase();
  
  // –ë–µ–∑—É—Å–ª–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ)
  if (/–ø–æ–ª—É—á–∏–ª\s+(–∑–ø|–∑–∞—Ä–ø–ª–∞—Ç—É?)/i.test(text) || 
      /–Ω–∞—á–∏—Å–ª–∏–ª–∏\s+(–∑–ø|–∑–∞—Ä–ø–ª–∞—Ç—É?)/i.test(text) ||
      lowerText.includes("–∑–∞—Ä–ø–ª–∞—Ç–∞") ||
      lowerText.includes("–ø–æ–ª—É—á–∏–ª –∑–ø")) {
    return enforceIncomeCategory("–ó–∞—Ä–ø–ª–∞—Ç–∞");
  }

  // 2. –ó–∞—Ç–µ–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Gemini –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
  const prompt = `–û–ø—Ä–µ–¥–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º:
  
  –ï—Å–ª–∏ –¥–æ—Ö–æ–¥ (–∑–∞—Ä–ø–ª–∞—Ç–∞, –ø—Ä–µ–º–∏—è, –≤–æ–∑–≤—Ä–∞—Ç) ‚Üí –≤–µ—Ä–Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑: ${getCategories('–¥–æ—Ö–æ–¥').join(', ')}
  –ï—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥ ‚Üí –≤–µ—Ä–Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑: ${getCategories('—Ä–∞—Å—Ö–æ–¥').join(', ')}
  
  –û–ø–µ—Ä–∞—Ü–∏—è: "${text}"
  
  –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`;

  const aiResponse = callGeminiApi(prompt)?.trim();
  
  // 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –ò–ò
  return validateCategory(aiResponse) || enforceIncomeCategory("–î–æ—Ö–æ–¥");
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function enforceIncomeCategory(category) {
  const incomeCategories = getCategories('–¥–æ—Ö–æ–¥');
  return incomeCategories.includes(category) ? category : 
         incomeCategories.includes("–î–æ—Ö–æ–¥") ? "–î–æ—Ö–æ–¥" :
         incomeCategories[0];
}

function validateCategory(category) {
  const allCategories = [...getCategories('–¥–æ—Ö–æ–¥'), ...getCategories('—Ä–∞—Å—Ö–æ–¥')];
  return allCategories.includes(category) ? category : null;
}
function handleUserInput(chat_id, text, userName) {
  const userProps = PropertiesService.getUserProperties();
  const state = userProps.getProperty(chat_id + "_state");

  if (state && state.startsWith("awaiting_goal_")) {
    handleGoalCreation(chat_id, text, state);
    return;
  }
  if (state && state.startsWith("awaiting_deposit|")) {
    const goalId = state.split("|")[1];
    const amount = parseFloat(text.replace(',', '.'));
    if (isNaN(amount) || amount <= 0) {
      return sendText(chat_id, "‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.");
    }
    addDepositToGoal(goalId, amount);
    userProps.deleteProperty(chat_id + "_state");
    sendText(chat_id, `‚úÖ –¶–µ–ª—å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ ${formatMoney(amount)} —Å—É–º!`);
    handleListGoals(chat_id);
    return;
  }
  if (state && state.startsWith("awaiting_budget_limit|")) {
    const category = state.split("|")[1];
    const limit = parseFloat(text.replace(',', '.'));
    if (isNaN(limit) || limit < 0) {
      return sendText(chat_id, "‚ùå –õ–∏–º–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.");
    }
    setBudgetForCategory(chat_id, category, limit);
    userProps.deleteProperty(chat_id + "_state");
    sendText(chat_id, `‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏–º–∏—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${category}": ${formatMoney(limit)} —Å—É–º.`);
    handleSetupBudgetManually(chat_id);
    return;
  }

  const awaitingAiQuestion = userProps.getProperty(chat_id + "_awaiting_ai_question");
  if (awaitingAiQuestion === "true") {
    try {
      const aiAnswer = getAiFinancialAnalysis(chat_id, text);
      sendText(chat_id, aiAnswer, "Markdown");
    } finally {
      userProps.deleteProperty(chat_id + "_awaiting_ai_question");
      sendMainMenu(chat_id);
    }
    return;
  }

  const selectedData = userProps.getProperty(chat_id + "_selected");
  if (selectedData) {
    const [type, category] = selectedData.split("|");
    const parts = text.match(/^(\d+[\.,]?\d*)\s*(.*)$/);
    if (!parts) {
      return sendText(chat_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. `–°—É–º–º–∞ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π`", "Markdown");
    }
    const amount = parseFloat(parts[1].replace(',', '.'));
    const comment = parts[2] ? parts[2].trim() : '';
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const targetSheetName = type === '–¥–æ—Ö–æ–¥' ? sheetIncome : sheetExpense;
    const sheet = ss.getSheetByName(targetSheetName);
    const rowNumber = sheet.getLastRow() + 1;
    sheet.appendRow([new Date(), category, amount, comment, chat_id]);
    userProps.deleteProperty(chat_id + "_selected");
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è
    const transactionInfo = {
      sheetName: targetSheetName,
      rowNumber: rowNumber,
      type: type,
      category: category,
      amount: amount,
      comment: comment
    };
    userProps.setProperty(chat_id + "_last_transaction", JSON.stringify(transactionInfo));
    
    const deleteKeyboard = {
      inline_keyboard: [
        [{ text: "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é", callback_data: `delete_last_transaction` }]
      ]
    };
    
    sendText(chat_id, `‚úÖ ${type === '–¥–æ—Ö–æ–¥' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'} –Ω–∞ ${formatMoney(amount)} —Å—É–º –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category}".`, null, deleteKeyboard);
    if (type === '—Ä–∞—Å—Ö–æ–¥') {
      checkBudgetLimit(chat_id, category);
    }
    sendMainMenu(chat_id);
    return;
  }

  const awaitingCategory = userProps.getProperty(chat_id + "_awaitingCategory");
  if (awaitingCategory === "true") {
    const ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settingSheet);
    const targetRow = findNextEmptyRowInColumn(ss, 1);
    ss.getRange(targetRow, 1).setValue(text);
    userProps.deleteProperty(chat_id + "_awaitingCategory");
    sendText(chat_id, `‚úÖ –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è "${text}" –¥–æ–±–∞–≤–ª–µ–Ω–∞.`);
    sendSettingsMenu(chat_id);
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ –¥–æ—Ö–æ–¥–æ–º –∏–ª–∏ —Ä–∞—Å—Ö–æ–¥–æ–º
  const parts = text.match(/^(\d+[\.,]?\d*)\s*(.*)$/);
  if (parts) {
    const amount = parseFloat(parts[1].replace(',', '.'));
    const comment = parts[2] ? parts[2].trim() : '';
    if (isNaN(amount) || amount <= 0) {
      return sendText(chat_id, "‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.");
    }
    const incomeCategories = getCategories('–¥–æ—Ö–æ–¥');
    const expenseCategories = getCategories('—Ä–∞—Å—Ö–æ–¥');
    const category = classifyExpenseWithAI(chat_id, comment || text);
    if (category) {
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const targetSheetName = incomeCategories.includes(category) ? sheetIncome : sheetExpense;
      const sheet = ss.getSheetByName(targetSheetName);
      const rowNumber = sheet.getLastRow() + 1;
      sheet.appendRow([new Date(), category, amount, comment || text, chat_id]);
      const type = incomeCategories.includes(category) ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è
      const transactionInfo = {
        sheetName: targetSheetName,
        rowNumber: rowNumber,
        type: type,
        category: category,
        amount: amount,
        comment: comment || text
      };
      userProps.setProperty(chat_id + "_last_transaction", JSON.stringify(transactionInfo));
      
      const deleteKeyboard = {
        inline_keyboard: [
          [{ text: "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é", callback_data: `delete_last_transaction` }]
        ]
      };
      
      sendText(chat_id, `‚úÖ ${type} –Ω–∞ ${formatMoney(amount)} —Å—É–º –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category}".`, null, deleteKeyboard);
      if (type === '–†–∞—Å—Ö–æ–¥') {
        checkBudgetLimit(chat_id, category);
      }
      sendMainMenu(chat_id);
      return;
    }
  }

  // –ï—Å–ª–∏ –ò–ò –Ω–µ —Å–º–æ–≥ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π
  const confirmationKeyboard = {
    inline_keyboard: [
      [{ text: "‚úÖ –î–∞, —Å–ø—Ä–æ—Å–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∞", callback_data: `ask_ai|${text}` }],
      [{ text: "‚õî –ù–µ—Ç, –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤—Ä—É—á–Ω—É—é", callback_data: `select_category|${text}` }]
    ]
  };
  sendText(chat_id, `–Ø –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ –Ω–µ —Å–º–æ–≥ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å: "*${text}*".\n–•–æ—Ç–∏—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤—Ä—É—á–Ω—É—é?`, "Markdown", confirmationKeyboard);
}
function handleCallbackQuery(callback) {
  const chat_id = String(callback.message.chat.id);
  const message_id = callback.message.message_id;
  const data = callback.data;
  answerCallback(callback.id);

  const action = data.split("|")[0];
  switch(action) {
    case 'ask_ai':
      deleteMessage(chat_id, message_id);
      const question = data.substring(data.indexOf('|') + 1);
      const aiAnswer = getAiFinancialAnalysis(chat_id, question);
      sendText(chat_id, aiAnswer, "Markdown");
      sendMainMenu(chat_id);
      break;
    case 'cancel_ai_question':
      deleteMessage(chat_id, message_id);
      sendMainMenu(chat_id);
      break;
    case 'select_category':
      deleteMessage(chat_id, message_id);
      const text = data.substring(data.indexOf('|') + 1);
      PropertiesService.getUserProperties().setProperty(chat_id + "_selected", `—Ä–∞—Å—Ö–æ–¥|${text}`);
      sendCategoryButtons(chat_id, '—Ä–∞—Å—Ö–æ–¥');
      break;
    case 'add_to_goal':
      const goalId = data.split("|")[1];
      const goalName = data.split("|")[2];
      PropertiesService.getUserProperties().setProperty(chat_id + "_state", `awaiting_deposit|${goalId}`);
      deleteMessage(chat_id, message_id);
      sendText(chat_id, `–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ —Ü–µ–ª—å *"${goalName}"*:`, "Markdown");
      break;
    case 'set_budget_limit':
      const category = data.split("|")[1];
      PropertiesService.getUserProperties().setProperty(chat_id + "_state", `awaiting_budget_limit|${category}`);
      deleteMessage(chat_id, message_id);
      sendText(chat_id, `–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ª–∏–º–∏—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *"${category}"* (0 –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è):`, "Markdown");
      break;
    case 'back_to_budget_menu':
      deleteMessage(chat_id, message_id);
      handleMyBudget(chat_id);
      break;
    case 'apply_ai_budget':
      deleteMessage(chat_id, message_id);
      const tempBudgetJson = PropertiesService.getUserProperties().getProperty(chat_id + "_temp_budget");
      if (!tempBudgetJson) {
        return sendText(chat_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç.");
      }
      const budgetToApply = JSON.parse(tempBudgetJson);
      for (const category in budgetToApply) {
        setBudgetForCategory(chat_id, category, budgetToApply[category]);
      }
      PropertiesService.getUserProperties().deleteProperty(chat_id + "_temp_budget");
      sendText(chat_id, "‚úÖ –ë—é–¥–∂–µ—Ç –æ—Ç –ò–ò —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω!");
      handleViewCurrentBudget(chat_id);
      break;
    case 'decline_ai_budget':
      deleteMessage(chat_id, message_id);
      PropertiesService.getUserProperties().deleteProperty(chat_id + "_temp_budget");
      sendText(chat_id, "‚ÑπÔ∏è –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω.");
      handleMyBudget(chat_id);
      break;
    case 'delete_last_transaction':
      deleteMessage(chat_id, message_id);
      handleDeleteLastTransaction(chat_id);
      break;
    case 'run_report':
      deleteMessage(chat_id, message_id);
      const reportType = data.split("|")[1];
      const scope = data.split("|")[2];
      const familyInfo = getFamilyInfo(chat_id);
      const userIds = scope === 'family' && familyInfo ? familyInfo.members.map(m => m.id) : [chat_id];
      const scopeText = scope === 'family' && familyInfo ? `(—Å–µ–º—å—è: ${familyInfo.name})` : `(–ª–∏—á–Ω—ã–π)`;
      if (reportType === 'balance') generateBalanceReport(chat_id, userIds, scopeText);
      if (reportType === 'detailed') generateDetailedReport(chat_id, userIds, scopeText);
      if (reportType === 'forecast') generateForecast(chat_id, userIds, scopeText);
      break;
    default:
      deleteMessage(chat_id, message_id);
      PropertiesService.getUserProperties().setProperty(chat_id + "_selected", data);
      sendText(chat_id, `–í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: *${data.split("|")[1]}*.\n\n–í–≤–µ–¥–∏—Ç–µ \`–°—É–º–º–∞ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\``, "Markdown");
      break;
  }
}
function getAiFinancialAnalysis(chat_id, question) {
  if (DEBUG_MODE) { 
    const debugPrompt = `–ö—Ä–∞—Ç–∫–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å: "${question}"`; 
    sendText(chat_id, "ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å..."); 
    return callGeminiApi(debugPrompt); 
  }
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const expenseSheet = ss.getSheetByName(sheetExpense); 
  const incomeSheet = ss.getSheetByName(sheetIncome);
  if (!expenseSheet || !incomeSheet) return "–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ª–∏—Å—Ç—ã '–î–æ—Ö–æ–¥—ã' –∏–ª–∏ '–†–∞—Å—Ö–æ–¥—ã'.";
  const userIdsForAnalysis = [chat_id];
  const dateLimit = new Date(); 
  dateLimit.setDate(dateLimit.getDate() - AI_ANALYSIS_DAYS);
  const allExpenseData = expenseSheet.getLastRow() > 1 ? expenseSheet.getRange(2, 1, expenseSheet.getLastRow() - 1, 5).getValues() : [];
  const allIncomeData = incomeSheet.getLastRow() > 1 ? incomeSheet.getRange(2, 1, incomeSheet.getLastRow() - 1, 5).getValues() : [];
  const recentExpenseData = allExpenseData.filter(row => userIdsForAnalysis.includes(String(row[4])) && new Date(row[0]) >= dateLimit);
  const recentIncomeData = allIncomeData.filter(row => userIdsForAnalysis.includes(String(row[4])) && new Date(row[0]) >= dateLimit);
  const expenseJson = recentExpenseData.map(row => ({ –¥–∞—Ç–∞: row[0].toLocaleDateString('ru-RU'), –∫–∞—Ç–µ–≥–æ—Ä–∏—è: row[1], —Å—É–º–º–∞: row[2], –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: row[3] }));
  const incomeJson = recentIncomeData.map(row => ({ –¥–∞—Ç–∞: row[0].toLocaleDateString('ru-RU'), –∫–∞—Ç–µ–≥–æ—Ä–∏—è: row[1], —Å—É–º–º–∞: row[2], –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: row[3] }));
  const goalsData = getUserGoals(chat_id);
  const goalsText = goalsData.length > 0 ? JSON.stringify(goalsData.map(g => ({–Ω–∞–∑–≤–∞–Ω–∏–µ: g.–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–ª—å: g.—Ü–µ–ª–µ–≤–∞—è_—Å—É–º–º–∞, –Ω–∞–∫–æ–ø–ª–µ–Ω–æ: g.–Ω–∞–∫–æ–ø–ª–µ–Ω–æ, –¥–µ–¥–ª–∞–π–Ω: g.–¥–µ–¥–ª–∞–π–Ω}))) : "–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π.";
  const prompt = `–¢—ã ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${AI_ANALYSIS_DAYS} –¥–Ω–µ–π. –ê–ö–¢–ò–í–ù–´–ï –¶–ï–õ–ò: ${goalsText}. –î–û–•–û–î–´: ${JSON.stringify(incomeJson)}. –†–ê–°–•–û–î–´: ${JSON.stringify(expenseJson)}. –í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "${question}". –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω: 1. –ö—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑. 2. –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç. 3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è. –í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ (–º–∞–∫—Å–∏–º—É–º 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), —á–µ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –£–±–µ—Ä–∏ –≤—Å—é "–≤–æ–¥—É". –ò—Å–ø–æ–ª—å–∑—É–π Markdown.`;
  sendText(chat_id, "ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ...");
  return callGeminiApi(prompt);
}
function handleMyBudget(chat_id) { 
  sendText(chat_id, "üí∞ –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º –±—é–¥–∂–µ—Ç–æ–º –Ω–∞ –º–µ—Å—è—Ü.", null, budgetKeyboard); 
}
function handleSuggestBudget(chat_id) {
  sendText(chat_id, "ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.");
  const averageExpenses = getAverageExpenses(chat_id, 3);
  if (Object.keys(averageExpenses).length === 0) { 
    return sendText(chat_id, "‚ÑπÔ∏è –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞."); 
  }
  const prompt = `–¢—ã ‚Äî —Å—Ç—Ä–æ–≥–∏–π, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –º–µ—Å—è—á–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Å—Ä–µ–¥–Ω–∏—Ö —Ç—Ä–∞—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞. –ü—Ä–µ–¥–ª–æ–∂–∏ –ª–∏–º–∏—Ç—ã –ø–æ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–µ–¥–ª–æ–∂–∏ –Ω–µ–±–æ–ª—å—à–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ (–Ω–∞ 10-15%), —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —ç–∫–æ–Ω–æ–º–∏—Ç—å. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –ü—Ä–∏–º–µ—Ä JSON: {"–ü—Ä–æ–¥—É–∫—Ç—ã": 2000000, "–¢–∞–∫—Å–∏": 500000} –î–∞–Ω–Ω—ã–µ –æ —Å—Ä–µ–¥–Ω–∏—Ö —Ç—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Å—É–º–∞—Ö): ${JSON.stringify(averageExpenses)} –°—Ñ–æ—Ä–º–∏—Ä—É–π –±—é–¥–∂–µ—Ç –∏ –≤–µ—Ä–Ω–∏ –µ–≥–æ –≤ –≤–∏–¥–µ JSON –æ–±—ä–µ–∫—Ç–∞. –ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, —Ç–æ–ª—å–∫–æ JSON.`;
  const aiResponse = callGeminiApi(prompt);
  try {
    const jsonString = aiResponse.match(/\{.*\}/s)[0];
    const suggestedBudget = JSON.parse(jsonString);
    let report = "ü§ñ *–ò–ò –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≤–∞—à–∏ —Ç—Ä–∞—Ç—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –±—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü:*\n\n";
    for (const category in suggestedBudget) { 
      report += ` - *${category}*: ${formatMoney(suggestedBudget[category])} —Å—É–º\n`; 
    }
    report += "\n–•–æ—Ç–∏—Ç–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –±—é–¥–∂–µ—Ç?";
    PropertiesService.getUserProperties().setProperty(chat_id + "_temp_budget", JSON.stringify(suggestedBudget));
    const confirmationKeyboard = { 
      inline_keyboard: [
        [{ text: "‚úÖ –î–∞, –ø—Ä–∏–º–µ–Ω–∏—Ç—å", callback_data: `apply_ai_budget` }],
        [{ text: "‚õî –ù–µ—Ç, —Å–ø–∞—Å–∏–±–æ", callback_data: `decline_ai_budget` }]
      ]
    };
    sendText(chat_id, report, "Markdown", confirmationKeyboard);
  } catch (e) { 
    Logger.log("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –±—é–¥–∂–µ—Ç–∞ –æ—Ç –ò–ò: " + e.toString() + ". –û—Ç–≤–µ—Ç –ò–ò: " + aiResponse); 
    sendText(chat_id, "‚ùå –ò–ò –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç –≤ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –ø–æ–∑–∂–µ."); 
  }
}
function handleSetupBudgetManually(chat_id) {
  const expenseCategories = getCategories('—Ä–∞—Å—Ö–æ–¥'); 
  const currentBudget = getBudget(chat_id);
  if (expenseCategories.length === 0) { 
    return sendText(chat_id, "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."); 
  }
  let text = "‚úèÔ∏è *–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±—é–¥–∂–µ—Ç–∞ –≤—Ä—É—á–Ω—É—é:*\n\n–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç.\n\n";
  const buttons = [];
  expenseCategories.forEach(cat => { 
    const limit = currentBudget[cat] || 0; 
    const buttonText = limit > 0 ? `${cat}: ${formatMoney(limit)} —Å—É–º` : `${cat}: (–Ω–µ –∑–∞–¥–∞–Ω)`; 
    buttons.push([{ text: buttonText, callback_data: `set_budget_limit|${cat}` }]); 
  });
  buttons.push([{ text: COMMANDS.backToSettings, callback_data: "back_to_budget_menu" }]);
  sendText(chat_id, text, "Markdown", { inline_keyboard: buttons });
}
function handleViewCurrentBudget(chat_id) {
  const budget = getBudget(chat_id);
  if (Object.keys(budget).length === 0) { 
    return sendText(chat_id, "‚ÑπÔ∏è –£ –≤–∞—Å –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –±—é–¥–∂–µ—Ç.", null, budgetKeyboard); 
  }
  const expenses = getExpensesForCurrentMonth([chat_id]);
  let report = "üëÄ *–í–∞—à –±—é–¥–∂–µ—Ç –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:*\n\n";
  for (const category in budget) {
    const limit = budget[category]; 
    const spent = expenses[category] || 0; 
    const remaining = limit - spent; 
    const progress = limit > 0 ? (spent / limit) * 100 : 0;
    report += `*${category}*:\n` + ` - –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${formatMoney(spent)} –∏–∑ ${formatMoney(limit)} —Å—É–º\n` + ` - –û—Å—Ç–∞—Ç–æ–∫: ${formatMoney(remaining)} —Å—É–º (${progress.toFixed(0)}%)\n\n`;
  }
  sendText(chat_id, report, "Markdown", budgetKeyboard);
}
function checkBudgetLimit(chat_id, category) {
  const budget = getBudget(chat_id); 
  const limit = budget[category]; 
  if (!limit) return;
  const expenses = getExpensesForCurrentMonth([chat_id]); 
  const totalSpent = expenses[category] || 0;
  const progress = (totalSpent / limit) * 100;
  if (progress >= 100) { 
    sendText(chat_id, `‚õî *–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç!* –í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ${progress.toFixed(0)}% –±—é–¥–∂–µ—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${category}".`); 
  }
  else if (progress >= 90) { 
    sendText(chat_id, `‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ!* –í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ —É–∂–µ ${progress.toFixed(0)}% –±—é–¥–∂–µ—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${category}".`); 
  }
}
function handleMyGoals(chat_id) { 
  sendText(chat_id, "üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ —Ü–µ–ª—è–º–∏.", null, goalsKeyboard); 
}
function handleNewGoal(chat_id) { 
  PropertiesService.getUserProperties().setProperty(chat_id + "_state", "awaiting_goal_name"); 
  sendText(chat_id, "–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏:", "Markdown"); 
}
function handleListGoals(chat_id) {
  const goals = getUserGoals(chat_id);
  if (goals.length === 0) { 
    return sendText(chat_id, "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π.", null, goalsKeyboard); 
  }
  sendText(chat_id, "üìã *–í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏:*", "Markdown");
  goals.forEach(goal => {
    const progress = goal.—Ü–µ–ª–µ–≤–∞—è_—Å—É–º–º–∞ > 0 ? (goal.–Ω–∞–∫–æ–ø–ª–µ–Ω–æ / goal.—Ü–µ–ª–µ–≤–∞—è_—Å—É–º–º–∞) * 100 : 0;
    const report = `üéØ *${goal.–Ω–∞–∑–≤–∞–Ω–∏–µ}*\n` + `   - –°–æ–±—Ä–∞–Ω–æ: ${formatMoney(goal.–Ω–∞–∫–æ–ø–ª–µ–Ω–æ)} –∏–∑ ${formatMoney(goal.—Ü–µ–ª–µ–≤–∞—è_—Å—É–º–º–∞)} —Å—É–º (${progress.toFixed(1)}%)\n` + `   - –î–µ–¥–ª–∞–π–Ω: ${goal.–¥–µ–¥–ª–∞–π–Ω}`;
    const inlineKeyboard = { inline_keyboard: [[{ text: "üéØ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", callback_data: `add_to_goal|${goal.id}|${goal.–Ω–∞–∑–≤–∞–Ω–∏–µ}` }]] };
    sendText(chat_id, report, "Markdown", inlineKeyboard);
  });
}
function handleGoalCreation(chat_id, text, state) {
  const userProps = PropertiesService.getUserProperties();
  const tempGoal = JSON.parse(userProps.getProperty(chat_id + "_temp_goal") || "{}");
  switch(state) {
    case "awaiting_goal_name": 
      tempGoal.name = text; 
      userProps.setProperty(chat_id + "_temp_goal", JSON.stringify(tempGoal)); 
      userProps.setProperty(chat_id + "_state", "awaiting_goal_amount"); 
      sendText(chat_id, "–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é —Å—É–º–º—É (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã):", "Markdown"); 
      break;
    case "awaiting_goal_amount": 
      const amount = parseFloat(text); 
      if (isNaN(amount) || amount <= 0) { 
        return sendText(chat_id, "‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –±–æ–ª—å—à–µ –Ω—É–ª—è."); 
      } 
      tempGoal.amount = amount; 
      userProps.setProperty(chat_id + "_temp_goal", JSON.stringify(tempGoal)); 
      userProps.setProperty(chat_id + "_state", "awaiting_goal_deadline"); 
      sendText(chat_id, "–ù–∞–ø–∏—à–∏—Ç–µ –¥–µ–¥–ª–∞–π–Ω (–î–î.–ú–ú.–ì–ì–ì–ì):", "Markdown"); 
      break;
    case "awaiting_goal_deadline": 
      tempGoal.deadline = text; 
      const goalsSheetObj = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(goalsSheet); 
      goalsSheetObj.appendRow(["G" + new Date().getTime(), chat_id, tempGoal.name, tempGoal.amount, 0, tempGoal.deadline]); 
      userProps.deleteProperty(chat_id + "_state"); 
      userProps.deleteProperty(chat_id + "_temp_goal"); 
      sendText(chat_id, `‚úÖ –ù–æ–≤–∞—è —Ü–µ–ª—å "${tempGoal.name}" —Å–æ–∑–¥–∞–Ω–∞!`); 
      handleMyGoals(chat_id); 
      break;
  }
}
function handleReportsMenu(chat_id) { 
  sendText(chat_id, "üìä –ú–µ–Ω—é –æ—Ç—á–µ—Ç–æ–≤ –∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤:", null, reportsKeyboard); 
}
function handleForecast(chat_id) { 
  if (chat_id === OWNER_ID) { 
    const keyboard = { 
      inline_keyboard: [
        [{ text: "üë§ –¢–æ–ª—å–∫–æ –º–æ–π", callback_data: "run_report|forecast|personal" }, 
         { text: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –û–±—â–∏–π —Å–µ–º–µ–π–Ω—ã–π", callback_data: "run_report|forecast|family" }]
      ]
    }; 
    sendText(chat_id, "–ö–∞–∫–æ–π –ø—Ä–æ–≥–Ω–æ–∑ —Å–¥–µ–ª–∞—Ç—å?", "Markdown", keyboard); 
  } else { 
    generateForecast(chat_id, [chat_id], "(–ª–∏—á–Ω—ã–π)"); 
  } 
}
function handleBalance(chat_id) { 
  if (chat_id === OWNER_ID) { 
    const keyboard = { 
      inline_keyboard: [
        [{ text: "üë§ –¢–æ–ª—å–∫–æ –º–æ–π", callback_data: "run_report|balance|personal" }, 
         { text: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –û–±—â–∏–π —Å–µ–º–µ–π–Ω—ã–π", callback_data: "run_report|balance|family" }]
      ]
    }; 
    sendText(chat_id, "–ö–∞–∫–æ–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ–∫–∞–∑–∞—Ç—å?", "Markdown", keyboard); 
  } else { 
    generateBalanceReport(chat_id, [chat_id], "(–ª–∏—á–Ω—ã–π)"); 
  } 
}
function sendReport(chat_id) { 
  if (chat_id === OWNER_ID) { 
    const keyboard = { 
      inline_keyboard: [
        [{ text: "üë§ –¢–æ–ª—å–∫–æ –º–æ–π", callback_data: "run_report|detailed|personal" }, 
         { text: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –û–±—â–∏–π —Å–µ–º–µ–π–Ω—ã–π", callback_data: "run_report|detailed|family" }]
      ]
    }; 
    sendText(chat_id, "–ö–∞–∫–æ–π –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å?", "Markdown", keyboard); 
  } else { 
    generateDetailedReport(chat_id, [chat_id], "(–ª–∏—á–Ω—ã–π)"); 
  } 
}
function sendMainMenu(chat_id) { 
  sendText(chat_id, "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", null, mainKeyboard); 
}
function sendSettingsMenu(chat_id) { 
  sendText(chat_id, "–ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫:", null, settingsKeyboard); 
}
function sendCategoryButtons(chat_id, type) { 
  const categories = getCategories(type); 
  if (!categories.length) return sendText(chat_id, `‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.`); 
  const buttons = categories.map(c => [{ text: c, callback_data: `${type}|${c}` }]); 
  sendText(chat_id, `–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:`, null, { inline_keyboard: buttons }); 
}
function askClearConfirmation(chat_id) { 
  const confKeyboard = { 
    inline_keyboard: [
      [{ text: "‚ö†Ô∏è –î–∞, –æ—á–∏—Å—Ç–∏—Ç—å!", callback_data: "clear|yes" }],
      [{ text: "‚õî –ù–µ—Ç", callback_data: "clear|no" }]
    ]
  }; 
  PropertiesService.getUserProperties().setProperty(chat_id + "_awaitingClearConfirmation", "true"); 
  sendText(chat_id, "‚ÄºÔ∏è *–í–ù–ò–ú–ê–ù–ò–ï!* ‚ÄºÔ∏è\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å *–í–°–ï* —Ä–∞—Å—Ö–æ–¥—ã –∏ –¥–æ—Ö–æ–¥—ã?", "Markdown", confKeyboard); 
}
function sendConfigureExpenseCategoryMenu(chat_id, message_id = null) { 
  sendText(chat_id, "–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ."); 
}
function handleFamilyMode(chat_id) { 
  sendText(chat_id, "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ—é —Å–µ–º—å—é –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π.", null, familyKeyboard); 
}
function handleCreateFamily(chat_id) { 
  const family = getFamilyInfo(chat_id); 
  if (family && chat_id !== OWNER_ID) { 
    return sendText(chat_id, `–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ —Å–µ–º—å–µ "${family.name}".`); 
  } 
  PropertiesService.getUserProperties().setProperty(chat_id + "_state", "awaiting_family_name"); 
  sendText(chat_id, "–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–π —Å–µ–º—å–∏:", "Markdown"); 
}
function handleJoinFamily(chat_id) { 
  const family = getFamilyInfo(chat_id); 
  if (family) { 
    return sendText(chat_id, `–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ —Å–µ–º—å–µ "${family.name}".`); 
  } 
  PropertiesService.getUserProperties().setProperty(chat_id + "_state", "awaiting_invite_code"); 
  sendText(chat_id, "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ:"); 
}
function handleViewMyFamily(chat_id) { 
  const family = getFamilyInfo(chat_id); 
  if (!family) { 
    return sendText(chat_id, "–í—ã –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ —Å–µ–º—å–µ.", null, familyKeyboard); 
  } 
  let message = `*–í–∞—à–∞ —Å–µ–º—å—è: ${family.name}*\n\n`; 
  message += `–ö–æ–¥ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:\n\`${family.inviteCode}\`\n\n`; 
  message += `–£—á–∞—Å—Ç–Ω–∏–∫–∏:\n`; 
  family.members.forEach(member => { 
    message += `- ${member.name}\n`; 
  }); 
  sendText(chat_id, message, "Markdown"); 
}
function handleLeaveFamily(chat_id) { 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(familiesSheet); 
  if (sheet.getLastRow() < 2) { 
    return sendText(chat_id, "–í—ã –Ω–µ —Å–æ—Å—Ç–æ—è–ª–∏ –≤ —Å–µ–º—å–µ.", null, familyKeyboard); 
  } 
  const data = sheet.getDataRange().getValues(); 
  let familyLeft = false; 
  for (let i = data.length - 1; i >= 1; i--) { 
    if (data[i][2] == chat_id) { 
      sheet.deleteRow(i + 1); 
      familyLeft = true; 
    } 
  } 
  if (familyLeft) { 
    sendText(chat_id, "–í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–∫–∏–Ω—É–ª–∏ —Å–µ–º—å—é.", null, familyKeyboard); 
  } else { 
    sendText(chat_id, "–í—ã –Ω–µ —Å–æ—Å—Ç–æ—è–ª–∏ –≤ —Å–µ–º—å–µ.", null, familyKeyboard); 
  } 
}

function handleDeleteLastTransaction(chat_id) {
  const userProps = PropertiesService.getUserProperties();
  const lastTransactionJson = userProps.getProperty(chat_id + "_last_transaction");
  
  if (!lastTransactionJson) {
    return sendText(chat_id, "‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.");
  }
  
  try {
    const transactionInfo = JSON.parse(lastTransactionJson);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(transactionInfo.sheetName);
    
    if (!sheet) {
      return sendText(chat_id, "‚ùå –û—à–∏–±–∫–∞: –ª–∏—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.");
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const rowData = sheet.getRange(transactionInfo.rowNumber, 1, 1, 5).getValues()[0];
    if (String(rowData[4]) !== chat_id) {
      return sendText(chat_id, "‚ùå –û—à–∏–±–∫–∞: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞–º.");
    }
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
    sheet.deleteRow(transactionInfo.rowNumber);
    
    // –£–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    userProps.deleteProperty(chat_id + "_last_transaction");
    
    const typeText = transactionInfo.type === '–î–æ—Ö–æ–¥' ? '–¥–æ—Ö–æ–¥' : '—Ä–∞—Å—Ö–æ–¥';
    sendText(chat_id, `‚úÖ ${typeText} –Ω–∞ ${formatMoney(transactionInfo.amount)} —Å—É–º –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${transactionInfo.category}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`);
    
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: " + error.toString());
    sendText(chat_id, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.");
  }
}

// =============================================
//           SHEET HELPERS
// =============================================
function formatMoney(num) { 
  return Number(num).toLocaleString('ru-RU'); 
}
function getCategories(type) { 
  const ss = SpreadsheetApp.getActiveSpreadsheet(); 
  const sheet = ss.getSheetByName(settingSheet); 
  if (!sheet) { 
    Logger.log(`–û—à–∏–±–∫–∞: –õ–∏—Å—Ç "${settingSheet}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`); 
    return []; 
  } 
  const column = type === '–¥–æ—Ö–æ–¥' ? 3 : 2; 
  return sheet.getRange(2, column, sheet.getMaxRows() - 1, 1).getValues().flat().filter(c => c && c.toString().trim()).sort((a, b) => a.localeCompare(b, 'ru')); 
}
function findNextEmptyRowInColumn(sheet, columnNumber) { 
  if (!sheet) return -1; 
  const values = sheet.getRange(1, columnNumber, sheet.getMaxRows(), 1).getValues(); 
  for (let i = 1; i < values.length; i++) { 
    if (values[i][0] === '') return i + 1; 
  } 
  return values.length + 1; 
}
function getUserGoals(chat_id) { 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(goalsSheet); 
  if (!sheet || sheet.getLastRow() < 2) return []; 
  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 6).getValues(); 
  return data.filter(row => String(row[1]) == chat_id).map(row => ({ 
    id: row[0], 
    –Ω–∞–∑–≤–∞–Ω–∏–µ: row[2], 
    —Ü–µ–ª–µ–≤–∞—è_—Å—É–º–º–∞: row[3], 
    –Ω–∞–∫–æ–ø–ª–µ–Ω–æ: row[4], 
    –¥–µ–¥–ª–∞–π–Ω: row[5] instanceof Date ? row[5].toLocaleDateString('ru-RU') : row[5] 
  })); 
}
function addDepositToGoal(goalId, amount) { 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(goalsSheet); 
  if (!sheet || sheet.getLastRow() < 2) return; 
  const data = sheet.getRange(1, 1, sheet.getLastRow(), 6).getValues(); 
  for (let i = 1; i < data.length; i++) { 
    if (data[i][0] == goalId) { 
      const currentAmount = data[i][4] || 0; 
      const cellToUpdate = sheet.getRange(i + 1, 5); 
      cellToUpdate.setValue(currentAmount + amount); 
      return; 
    } 
  } 
}
function setBudgetForCategory(chat_id, category, limit) { 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(budgetsSheet); 
  const data = sheet.getDataRange().getValues(); 
  let found = false; 
  for (let i = 1; i < data.length; i++) { 
    if (String(data[i][0]) == chat_id && data[i][1] == category) { 
      if (limit > 0) { 
        sheet.getRange(i + 1, 3).setValue(limit); 
      } else { 
        sheet.deleteRow(i + 1); 
      } 
      found = true; 
      break; 
    } 
  } 
  if (!found && limit > 0) { 
    sheet.appendRow([chat_id, category, limit]); 
  } 
}
function getBudget(chat_id) { 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(budgetsSheet); 
  if (!sheet || sheet.getLastRow() < 2) return {}; 
  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 3).getValues(); 
  const budget = {}; 
  data.forEach(row => { 
    if (String(row[0]) == chat_id) { 
      budget[row[1]] = row[2]; 
    } 
  }); 
  return budget; 
}
function getExpensesForCurrentMonth(userIds) { 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetExpense); 
  if (!sheet || sheet.getLastRow() < 2) return {}; 
  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 5).getValues(); 
  const expenses = {}; 
  const now = new Date(); 
  data.forEach(row => { 
    if (userIds.includes(String(row[4]))) { 
      const expenseDate = new Date(row[0]); 
      if (expenseDate.getMonth() === now.getMonth() && expenseDate.getFullYear() === now.getFullYear()) { 
        const category = row[1]; 
        const amount = row[2]; 
        expenses[category] = (expenses[category] || 0) + amount; 
      } 
    } 
  }); 
  return expenses; 
}
function getAverageExpenses(chat_id, months) { 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetExpense); 
  if (!sheet || sheet.getLastRow() < 2) return {}; 
  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 5).getValues(); 
  const expensesByMonth = {}; 
  const dateLimit = new Date(); 
  dateLimit.setMonth(dateLimit.getMonth() - months); 
  data.forEach(row => { 
    if(String(row[4]) == chat_id) { 
      const expenseDate = new Date(row[0]); 
      if (expenseDate >= dateLimit) { 
        const monthYear = `${expenseDate.getFullYear()}-${expenseDate.getMonth()}`; 
        const category = row[1]; 
        const amount = row[2]; 
        if (!expensesByMonth[monthYear]) { 
          expensesByMonth[monthYear] = {}; 
        } 
        expensesByMonth[monthYear][category] = (expensesByMonth[monthYear][category] || 0) + amount; 
      } 
    } 
  }); 
  const numMonths = Object.keys(expensesByMonth).length; 
  if (numMonths === 0) return {}; 
  const totalExpenses = {}; 
  for (const month in expensesByMonth) { 
    for (const category in expensesByMonth[month]) { 
      totalExpenses[category] = (totalExpenses[category] || 0) + expensesByMonth[month][category]; 
    } 
  } 
  const averageExpenses = {}; 
  for (const category in totalExpenses) { 
    averageExpenses[category] = Math.round(totalExpenses[category] / numMonths); 
  } 
  return averageExpenses; 
}
function getIncomeForCurrentMonth(userIds) { 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetIncome); 
  if (!sheet || sheet.getLastRow() < 2) return 0; 
  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 5).getValues(); 
  let totalIncome = 0; 
  const now = new Date(); 
  data.forEach(row => { 
    if (userIds.includes(String(row[4]))) { 
      const incomeDate = new Date(row[0]); 
      if (incomeDate.getMonth() === now.getMonth() && incomeDate.getFullYear() === now.getFullYear()) { 
        totalIncome += Number(row[2] || 0); 
      } 
    } 
  }); 
  return totalIncome; 
}
function createFamily(chat_id, userName, familyName) { 
  PropertiesService.getUserProperties().deleteProperty(chat_id + "_state"); 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(familiesSheet); 
  const familyId = "FAM-" + new Date().getTime(); 
  const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
  sheet.appendRow([familyId, inviteCode, chat_id, userName, familyName]); 
  sendText(chat_id, `‚úÖ –°–µ–º—å—è "${familyName}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`); 
  handleViewMyFamily(chat_id); 
}
function joinFamily(chat_id, userName, inviteCode) { 
  PropertiesService.getUserProperties().deleteProperty(chat_id + "_state"); 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(familiesSheet); 
  const data = sheet.getDataRange().getValues(); 
  let familyFound = null; 
  let familyName = ''; 
  for (let i = 1; i < data.length; i++) { 
    if (data[i][1] == inviteCode.trim().toUpperCase()) { 
      familyFound = { id: data[i][0] }; 
      familyName = data[i][4]; 
      break; 
    } 
  } 
  if (familyFound) { 
    sheet.appendRow([familyFound.id, inviteCode.trim().toUpperCase(), chat_id, userName, familyName]); 
    sendText(chat_id, `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Å–µ–º—å–µ "${familyName}".`); 
    handleViewMyFamily(chat_id); 
  } else { 
    sendText(chat_id, "‚ùå –°–µ–º—å—è —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."); 
  } 
}
function getFamilyInfo(chat_id) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(familiesSheet);
  if (!sheet || sheet.getLastRow() < 2) return null;
  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 5).getValues();
  let userFamilyId = null;
  for (const row of data) { 
    if (String(row[2]) == chat_id) { 
      userFamilyId = row[0]; 
      break; 
    } 
  }
  if (!userFamilyId) return null;
  const familyMembers = data.filter(row => row[0] == userFamilyId);
  const familyName = familyMembers[0][4] || "–°–µ–º—å—è " + familyMembers[0][3];
  return { 
    id: userFamilyId, 
    name: familyName, 
    inviteCode: familyMembers[0][1], 
    members: familyMembers.map(row => ({ id: String(row[2]), name: row[3] })) 
  };
}
function getAllUserIds() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const incomeSheet = ss.getSheetByName(sheetIncome);
  const expenseSheet = ss.getSheetByName(sheetExpense);
  const userIds = new Set();
  
  if (incomeSheet && incomeSheet.getLastRow() > 1) {
    const incomeData = incomeSheet.getRange(2, 5, incomeSheet.getLastRow() - 1, 1).getValues();
    incomeData.forEach(row => userIds.add(String(row[0])));
  }
  
  if (expenseSheet && expenseSheet.getLastRow() > 1) {
    const expenseData = expenseSheet.getRange(2, 5, expenseSheet.getLastRow() - 1, 1).getValues();
    expenseData.forEach(row => userIds.add(String(row[0])));
  }
  
  return Array.from(userIds);
}

function getDebtsAndCredits(userIds) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(debtsSheet);
  
  // –ï—Å–ª–∏ –ª–∏—Å—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
  if (!sheet) {
    const newSheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet(debtsSheet);
    newSheet.getRange(1, 1, 1, 12).setValues([
      ['–î–∞—Ç–∞', 'ChatID', '–¢–∏–ø', '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', '–°—É–º–º–∞', '–í–∞–ª—é—Ç–∞', '–°—É–º–º–∞_UZS', '–û–ø–∏—Å–∞–Ω–∏–µ', '–î–∞—Ç–∞_–≤–æ–∑–≤—Ä–∞—Ç–∞', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞_–ø–æ–≥–∞—à–µ–Ω–∏—è', '–°—É–º–º–∞_–ø–æ–≥–∞—à–µ–Ω–∏—è']
    ]);
    return { totalDebt: 0, totalCredit: 0 }; // –ù–æ–≤—ã–π –ª–∏—Å—Ç - –Ω–µ—Ç –¥–æ–ª–≥–æ–≤
  }
  
  if (sheet.getLastRow() < 2) {
    return { totalDebt: 0, totalCredit: 0 }; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
  }
  
  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 12).getValues();
  let totalDebt = 0;    // –°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω (–¥–µ–±–µ—Ç)
  let totalCredit = 0;  // –°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ–ª–∂–Ω—ã (–∫—Ä–µ–¥–∏—Ç)
  
  data.forEach(row => {
    if (userIds.includes(String(row[1])) && row[9] === '–ê–∫—Ç–∏–≤–µ–Ω') { // row[1] = ChatID, row[9] = –°—Ç–∞—Ç—É—Å
      const type = row[2];        // –î–µ–±–µ—Ç –∏–ª–∏ –ö—Ä–µ–¥–∏—Ç
      const amountUZS = parseFloat(row[6]) || 0; // –°—É–º–º–∞ –≤ UZS
      const paidAmount = parseFloat(row[11]) || 0; // –ü–æ–≥–∞—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞
      const remainingAmount = amountUZS - paidAmount;
      
      if (remainingAmount > 0) {
        if (type === '–î–µ–±–µ—Ç') {
          totalDebt += remainingAmount;      // –Ø –¥–æ–ª–∂–µ–Ω
        } else if (type === '–ö—Ä–µ–¥–∏—Ç') {
          totalCredit += remainingAmount;    // –ú–Ω–µ –¥–æ–ª–∂–Ω—ã
        }
      }
    }
  });
  
  return { totalDebt, totalCredit };
}

function generateBalanceReport(chat_id, userIds, scopeText) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const incomeSheet = ss.getSheetByName(sheetIncome); 
  const expenseSheet = ss.getSheetByName(sheetExpense);
  const allIncomes = incomeSheet.getLastRow() > 1 ? incomeSheet.getRange(2, 1, incomeSheet.getLastRow() - 1, 5).getValues() : [];
  const allExpenses = expenseSheet.getLastRow() > 1 ? expenseSheet.getRange(2, 1, expenseSheet.getLastRow() - 1, 5).getValues() : [];
  const incomeTotal = allIncomes.filter(row => userIds.includes(String(row[4]))).reduce((sum, row) => sum + Number(row[2] || 0), 0);
  const expenseTotal = allExpenses.filter(row => userIds.includes(String(row[4]))).reduce((sum, row) => sum + Number(row[2] || 0), 0);
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–æ–ª–≥–∞—Ö
  const { totalDebt, totalCredit } = getDebtsAndCredits(userIds);
  
  // –†–∞—Å—á–µ—Ç—ã –ø–æ –≤–∞—à–µ–º—É —Ñ–æ—Ä–º–∞—Ç—É
  const onHand = incomeTotal + totalDebt - expenseTotal; // –ù–∞ —Ä—É–∫–∞—Ö = –î–æ—Ö–æ–¥—ã + –î–æ–ª–≥–∏ - –†–∞—Å—Ö–æ–¥—ã
  const minusDebt = -totalDebt; // –ú–∏–Ω—É—Å –¥–æ–ª–≥ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
  const finalBalance = onHand + minusDebt; // –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å = –ù–∞ —Ä—É–∫–∞—Ö + –ú–∏–Ω—É—Å –¥–æ–ª–≥
  
  let report = `üìä *–õ–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å:*\n\n`;
  report += `üí∞ –î–æ—Ö–æ–¥—ã: ${formatMoney(incomeTotal)}\n`;
  report += `üí≥ –í–∑—è–ª –≤ –¥–æ–ª–≥: ${formatMoney(totalDebt)}\n`;
  report += `üõí –†–∞—Å—Ö–æ–¥—ã: ${formatMoney(expenseTotal)}\n\n`;
  report += `üì¶ –ù–∞ —Ä—É–∫–∞—Ö: ${formatMoney(onHand)}\n`;
  report += `üìâ –ú–∏–Ω—É—Å –¥–æ–ª–≥: ${formatMoney(minusDebt)}\n\n`;
  report += `‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${formatMoney(finalBalance)}`;
  
  sendText(chat_id, report, "Markdown");
}
function generateDetailedReport(chat_id, userIds, scopeText) {
  const expenses = getExpensesForCurrentMonth(userIds);

  if (Object.keys(expenses).length === 0) {
    return sendText(chat_id, `üìä *–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç ${scopeText}:*\n\n–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ.`, "Markdown");
  }

  const sortedExpenses = Object.entries(expenses).sort(([,a],[,b]) => b-a);
  const sortedData = Object.fromEntries(sortedExpenses);

  let caption = `üìä *–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ ${scopeText} –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:*\n\n`;
  let totalExpenses = 0;
  sortedExpenses.forEach(([, amount]) => {
    totalExpenses += amount;
  });

  sortedExpenses.forEach(([category, amount]) => {
    const percentage = ((amount / totalExpenses) * 100).toFixed(1);
    caption += `- *${category}*: ${formatMoney(amount)} —Å—É–º (${percentage}%)\n`;
  });
  caption += `\n*–ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤:* ${formatMoney(totalExpenses)} —Å—É–º`;

  const chartUrl = generateChartUrl(sortedData);
  sendPhoto(chat_id, chartUrl, caption);
}
function generateForecast(chat_id, userIds, scopeText) {
  sendText(chat_id, `üîÆ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é –ø—Ä–æ–≥–Ω–æ–∑ ${scopeText}...`);
  const today = new Date();
  const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
  const dayOfMonth = today.getDate();
  if (dayOfMonth >= daysInMonth - 1) { 
    return sendText(chat_id, "üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞, —Ç–∞–∫ –∫–∞–∫ –º–µ—Å—è—Ü –ø–æ—á—Ç–∏ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è."); 
  }
  const daysPassed = dayOfMonth; 
  const daysRemaining = daysInMonth - dayOfMonth;
  const incomeThisMonth = getIncomeForCurrentMonth(userIds);
  const expensesThisMonthObj = getExpensesForCurrentMonth(userIds);
  const expensesThisMonthTotal = Object.values(expensesThisMonthObj).reduce((a, b) => a + b, 0);
  const currentBalanceForMonth = incomeThisMonth - expensesThisMonthTotal;
  const averageDailySpend = daysPassed > 0 ? expensesThisMonthTotal / daysPassed : 0;
  const projectedFutureSpend = averageDailySpend * daysRemaining;
  const projectedFinalBalance = currentBalanceForMonth - projectedFutureSpend;
  const prompt = `–¢—ã ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫-–ø—Ä–æ–≥–Ω–æ–∑–∏—Å—Ç. –ù–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—á–µ—Ç–æ–≤, —Å–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑. - –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∑–∞ –º–µ—Å—è—Ü: ${formatMoney(currentBalanceForMonth)} —Å—É–º. - –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å: ${formatMoney(averageDailySpend)} —Å—É–º. - –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞: ${formatMoney(projectedFutureSpend)} —Å—É–º. - –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞: ${formatMoney(projectedFinalBalance)} —Å—É–º. –°—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—Ç—Å—è –¥–µ—Ñ–∏—Ü–∏—Ç, –¥–∞–π —Å—Ç—Ä–æ–≥–∏–π —Å–æ–≤–µ—Ç. –ï—Å–ª–∏ –≤—Å–µ —Ö–æ—Ä–æ—à–æ, –ø–æ—Ö–≤–∞–ª–∏. –í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–∏–º (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).`;
  const forecast = callGeminiApi(prompt);
  sendText(chat_id, forecast, "Markdown");
}
function generateChartUrl(data) {
  const MAX_CATEGORIES_TO_SHOW = 7;
  
  if (!data || Object.keys(data).length === 0) {
    return generateEmptyChartUrl();
  }
  
  const sortedEntries = Object.entries(data).sort(([,a], [,b]) => b - a);
  let originalLabels = sortedEntries.map(([label]) => label);
  let originalValues = sortedEntries.map(([,value]) => value);
  
  let chartLabels = originalLabels;
  let chartValues = originalValues;

  if (originalLabels.length > MAX_CATEGORIES_TO_SHOW) {
    const topLabels = originalLabels.slice(0, MAX_CATEGORIES_TO_SHOW - 1);
    const topValues = originalValues.slice(0, MAX_CATEGORIES_TO_SHOW - 1);
    const otherValues = originalValues.slice(MAX_CATEGORIES_TO_SHOW - 1);
    const otherSum = otherValues.reduce((sum, current) => sum + current, 0);
    
    chartLabels = [...topLabels, '–ü—Ä–æ—á–µ–µ'];
    chartValues = [...topValues, otherSum];
  }
  
  const totalSum = chartValues.reduce((sum, val) => sum + val, 0);
  
  if (totalSum === 0) {
    return generateEmptyChartUrl();
  }

  const chartConfig = {
    type: 'outlabeledPie',
    data: {
      labels: chartLabels,
      datasets: [{
        backgroundColor: [
          '#FF9B27', '#FF682B', '#CB275A', '#47338C',
          '#2764B4', '#02B1C4', '#3BBAED', '#A8E6CF'
        ],
        data: chartValues,
        borderWidth: 2,
        borderColor: '#ffffff'
      }]
    },
    options: {
      plugins: {
        legend: false,
        outlabels: {
          text: '%l\n%p',
          color: '#fcfafa',
          stretch: 45,
          font: {
            resizable: true,
            minSize: 18,
            maxSize: 24,
            weight: 'bold'
          },
          lineColor: '#666666',
          lineWidth: 1
        }
      },
      layout: {
        padding: {
          top: 40,
          bottom: 40,
          left: 40,
          right: 40
        }
      }
    }
  };

  try {
    const finalUrl = "https://quickchart.io/chart?bkg=white&w=1400&h=800&c=" +
                      encodeURIComponent(JSON.stringify(chartConfig));
    
    return finalUrl;
    
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ outlabeled –¥–∏–∞–≥—Ä–∞–º–º—ã: " + error.toString());
    return generateFallbackChart(chartLabels, chartValues);
  }
}
function generateChartUrlWithAmounts(data) {
  const MAX_CATEGORIES_TO_SHOW = 7;
  
  if (!data || Object.keys(data).length === 0) {
    return generateEmptyChartUrl();
  }
  
  const sortedEntries = Object.entries(data).sort(([,a], [,b]) => b - a);
  let originalLabels = sortedEntries.map(([label]) => label);
  let originalValues = sortedEntries.map(([,value]) => value);
  
  let chartLabels = originalLabels;
  let chartValues = originalValues;

  if (originalLabels.length > MAX_CATEGORIES_TO_SHOW) {
    const topLabels = originalLabels.slice(0, MAX_CATEGORIES_TO_SHOW - 1);
    const topValues = originalValues.slice(0, MAX_CATEGORIES_TO_SHOW - 1);
    const otherValues = originalValues.slice(MAX_CATEGORIES_TO_SHOW - 1);
    const otherSum = otherValues.reduce((sum, current) => sum + current, 0);
    
    chartLabels = [...topLabels, '–ü—Ä–æ—á–µ–µ'];
    chartValues = [...topValues, otherSum];
  }
  
  const totalSum = chartValues.reduce((sum, val) => sum + val, 0);
  
  if (totalSum === 0) {
    return generateEmptyChartUrl();
  }

  const chartConfig = {
    type: 'outlabeledPie',
    data: {
      labels: chartLabels,
      datasets: [{
        backgroundColor: [
          '#FF9B27', '#FF682B', '#CB275A', '#47338C',
          '#2764B4', '#02B1C4', '#3BBAED', '#A8E6CF'
        ],
        data: chartValues
      }]
    },
    options: {
      plugins: {
        legend: false,
        outlabels: {
          text: function(context) {
            const value = context.dataset.data[context.dataIndex];
            const percentage = ((value / totalSum) * 100).toFixed(1);
            const formattedValue = formatMoney(value);
            return `${context.label}\n${formattedValue}\n(${percentage}%)`;
          },
          color: '#333333',
          stretch: 30,
          font: {
            resizable: true,
            minSize: 10,
            maxSize: 13
          }
        }
      }
    }
  };
  
  return "https://quickchart.io/chart?bkg=white&w=1400&h=800&c=" +
         encodeURIComponent(JSON.stringify(chartConfig));
}
function generateFallbackChart(labels, values) {
  const totalSum = values.reduce((sum, val) => sum + val, 0);
  
  const config = {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: [
          '#FF9B27', '#FF682B', '#CB275A', '#47338C',
          '#2764B4', '#02B1C4', '#3BBAED'
        ]
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'right'
        },
        datalabels: {
          display: true,
          formatter: function(value) {
            const percentage = ((value / totalSum) * 100).toFixed(0);
            return percentage + '%';
          },
          color: '#fff',
          font: { weight: 'bold' }
        }
      }
    }
  };
  
  return "https://quickchart.io/chart?w=1200&h=600&c=" + encodeURIComponent(JSON.stringify(config));
}
function generateEmptyChartUrl() {
  const emptyConfig = {
    type: 'outlabeledPie',
    data: {
      labels: ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
      datasets: [{
        data: [1],
        backgroundColor: ['#E0E0E0']
      }]
    },
    options: {
      plugins: {
        legend: false,
        outlabels: {
          text: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\n–æ —Ä–∞—Å—Ö–æ–¥–∞—Ö',
          color: '#666666'
        }
      }
    }
  };
  
  return "https://quickchart.io/chart?bkg=white&w=1200&h=600&c=" +
         encodeURIComponent(JSON.stringify(emptyConfig));
}

// =============================================
//           DO GET
// =============================================
function doGet() { 
  return ContentService.createTextOutput("Telegram Bot Script is active."); 
}